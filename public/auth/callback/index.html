<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <!-- LOCAL BYPASS FIX: Alias path for callback to support /auth/callback during dev. Remove when backend renders its own dialog bridge. -->
    <title>Auth Callback</title>
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
  </head>
  <body>
    <script>
      (async function () {
        try {
          const hash = window.location.hash ? window.location.hash.substring(1) : '';
          const hp = new URLSearchParams(hash);
          const token = hp.get('token');
          const graphToken = hp.get('graphToken');
          const userRaw = hp.get('user');
          let user = null;
          try { user = userRaw ? JSON.parse(decodeURIComponent(userRaw)) : null } catch { try { user = userRaw ? JSON.parse(userRaw) : null } catch { try { user = userRaw ? JSON.parse(atob(userRaw)) : null } catch {} } }
          const payload = token && graphToken && user ? { success: true, token, graphToken, user } : { success: false };
          try { localStorage.setItem('olxcat_auth_result', JSON.stringify(payload)); } catch {}
          const msg = JSON.stringify(payload);
          if (window.Office && Office.context && Office.context.ui && Office.context.ui.messageParent) {
            Office.onReady(() => { Office.context.ui.messageParent(msg); window.close(); });
          } else if (window.opener) {
            window.opener.postMessage(msg, '*');
            window.close();
          } else {
            document.body.textContent = 'You can close this window.';
          }
        } catch (e) {
          const msg = JSON.stringify({ success: false, error: { message: 'Callback error' } });
          try {
            if (window.Office && Office.context && Office.context.ui && Office.context.ui.messageParent) {
              Office.onReady(() => { Office.context.ui.messageParent(msg); window.close(); });
              return;
            }
          } catch {}
          try { if (window.opener) { window.opener.postMessage(msg, '*'); window.close(); return; } } catch {}
          document.body.textContent = 'Authentication failed; you may close this window.';
        }
      })();
    </script>
  </body>
  </html>


